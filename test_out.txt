DEBUG_DB: Driver=postgresql+asyncpg, Host=localhost, DB=giftyai
DEBUG_DB: User=giftyai_user, Params=immutabledict({})
============================= test session starts ==============================
platform darwin -- Python 3.9.6, pytest-8.4.2, pluggy-1.6.0 -- /Library/Developer/CommandLineTools/usr/bin/python3
cachedir: .pytest_cache
Fugue tests will be initialized with options:
rootdir: /Users/artyomkonukhov/Projects/gifty-backend
configfile: pytest.ini
plugins: fugue-0.9.3, mock-3.15.1, asyncio-1.2.0, anyio-4.10.0, hydra-core-1.3.2, cov-7.0.0
asyncio: mode=strict, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 1 item

tests/recommendations/test_discovery_e2e.py::test_full_discovery_flow_e2e FAILED /init: 500 - {"error":{"code":"http_error","message":"Internal server error during discovery initialization"}}
FAILED

=================================== FAILURES ===================================
_________________________ test_full_discovery_flow_e2e _________________________

e2e_client = <starlette.testclient.TestClient object at 0x11dc92e50>
sqlite_db_session = <async_generator object sqlite_db_session at 0x11dc861f0>

    @pytest.mark.asyncio
    async def test_full_discovery_flow_e2e(e2e_client, sqlite_db_session):
        """
        Test the full discovery flow path:
        1. /init -> Start session
        2. /interact -> Like a hypothesis
        3. /hypothesis/{id}/products -> Get recommendations
        4. /hypothesis/{id}/react -> Final reaction
        """
    
        # --- STEP 1: INIT ---
        quiz_data = {
            "interests": ["Coffee", "Gadgets"],
            "recipient_age": 30,
            "recipient_gender": "male",
            "budget": 5000,
            "deadline_days": 7,
            "effort_level": "medium",
            "language": "ru",
            "relationship": "friend"
        }
    
        # Mock Anthropic responses for predictability
        mock_hypos = {
            "Coffee": {
                "hypotheses": [
                    {
                        "title": "AeroPress Kit",
                        "description": "Brew anywhere",
                        "reasoning": "He likes coffee",
                        "primary_gap": "the_optimizer",
                        "search_queries": ["aeropress"]
                    }
                ]
            },
            "Gadgets": {
                "hypotheses": [
                    {
                        "title": "Smart Light",
                        "description": "RGB goodness",
                        "reasoning": "He likes tech",
                        "primary_gap": "the_catalyst",
                        "search_queries": ["smart bulbs"]
                    }
                ]
            }
        }
    
        # Mock notifications to avoid pika errors in tests
        mock_notifier = AsyncMock()
    
        with patch("app.services.anthropic_service.AnthropicService.normalize_topics", AsyncMock(return_value=["Coffee", "Gadgets"])), \
             patch("app.services.anthropic_service.AnthropicService.generate_hypotheses_bulk", AsyncMock(return_value=mock_hypos)), \
             patch("app.services.dialogue_manager.get_notification_service", return_value=mock_notifier):
    
            response = e2e_client.post("/api/v1/recommendations/init", json=quiz_data)
            if response.status_code != 200:
                print(f"FAILED /init: {response.status_code} - {response.text}")
>           assert response.status_code == 200
E           assert 500 == 200
E            +  where 500 = <Response [500 Internal Server Error]>.status_code

tests/recommendations/test_discovery_e2e.py:92: AssertionError
------------------------------ Captured log call -------------------------------
WARNING  app.services.intelligence:intelligence.py:25 IntelligenceAPI token missing, using dummy embeddings.
ERROR    app.repositories.catalog:catalog.py:215 CatalogRepository.search_similar_products failed: 'async_generator' object has no attribute 'execute'
ERROR    pika.adapters.utils.selector_ioloop_adapter:selector_ioloop_adapter.py:569 Address resolution failed: gaierror(8, 'nodename nor servname provided, or not known')
ERROR    pika.adapters.utils.connection_workflow:connection_workflow.py:799 getaddrinfo failed: gaierror(8, 'nodename nor servname provided, or not known').
ERROR    pika.adapters.utils.connection_workflow:connection_workflow.py:746 AMQP connection workflow failed: AMQPConnectionWorkflowFailed: 1 exceptions in all; last exception - gaierror(8, 'nodename nor servname provided, or not known'); first exception - None.
ERROR    pika.adapters.utils.connection_workflow:connection_workflow.py:723 AMQPConnectionWorkflow - reporting failure: AMQPConnectionWorkflowFailed: 1 exceptions in all; last exception - gaierror(8, 'nodename nor servname provided, or not known'); first exception - None
ERROR    pika.adapters.blocking_connection:blocking_connection.py:450 Connection workflow failed: AMQPConnectionWorkflowFailed: 1 exceptions in all; last exception - gaierror(8, 'nodename nor servname provided, or not known'); first exception - None
ERROR    pika.adapters.blocking_connection:blocking_connection.py:457 Error in _create_connection().
Traceback (most recent call last):
  File "/Users/artyomkonukhov/Projects/gifty-backend/app/repositories/catalog.py", line 212, in search_similar_products
    result = await self.session.execute(stmt)
AttributeError: 'async_generator' object has no attribute 'execute'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/pika/adapters/blocking_connection.py", line 451, in _create_connection
    raise self._reap_last_connection_workflow_error(error)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/pika/adapters/utils/selector_ioloop_adapter.py", line 565, in _resolve
    result = socket.getaddrinfo(self._host, self._port, self._family,
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/socket.py", line 953, in getaddrinfo
    for res in _socket.getaddrinfo(host, port, family, type, proto, flags):
socket.gaierror: [Errno 8] nodename nor servname provided, or not known
ERROR    app.services.notifications:notifications.py:64 Failed to publish notification: [Errno 8] nodename nor servname provided, or not known
WARNING  app.repositories.catalog:catalog.py:228 DB search failed, returning empty list (dev mode)
WARNING  app.services.intelligence:intelligence.py:25 IntelligenceAPI token missing, using dummy embeddings.
ERROR    app.repositories.catalog:catalog.py:215 CatalogRepository.search_similar_products failed: 'async_generator' object has no attribute 'execute'
ERROR    pika.adapters.utils.selector_ioloop_adapter:selector_ioloop_adapter.py:569 Address resolution failed: gaierror(8, 'nodename nor servname provided, or not known')
ERROR    pika.adapters.utils.connection_workflow:connection_workflow.py:799 getaddrinfo failed: gaierror(8, 'nodename nor servname provided, or not known').
ERROR    pika.adapters.utils.connection_workflow:connection_workflow.py:746 AMQP connection workflow failed: AMQPConnectionWorkflowFailed: 1 exceptions in all; last exception - gaierror(8, 'nodename nor servname provided, or not known'); first exception - None.
ERROR    pika.adapters.utils.connection_workflow:connection_workflow.py:723 AMQPConnectionWorkflow - reporting failure: AMQPConnectionWorkflowFailed: 1 exceptions in all; last exception - gaierror(8, 'nodename nor servname provided, or not known'); first exception - None
ERROR    pika.adapters.blocking_connection:blocking_connection.py:450 Connection workflow failed: AMQPConnectionWorkflowFailed: 1 exceptions in all; last exception - gaierror(8, 'nodename nor servname provided, or not known'); first exception - None
ERROR    pika.adapters.blocking_connection:blocking_connection.py:457 Error in _create_connection().
Traceback (most recent call last):
  File "/Users/artyomkonukhov/Projects/gifty-backend/app/repositories/catalog.py", line 212, in search_similar_products
    result = await self.session.execute(stmt)
AttributeError: 'async_generator' object has no attribute 'execute'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/pika/adapters/blocking_connection.py", line 451, in _create_connection
    raise self._reap_last_connection_workflow_error(error)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/pika/adapters/utils/selector_ioloop_adapter.py", line 565, in _resolve
    result = socket.getaddrinfo(self._host, self._port, self._family,
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/socket.py", line 953, in getaddrinfo
    for res in _socket.getaddrinfo(host, port, family, type, proto, flags):
socket.gaierror: [Errno 8] nodename nor servname provided, or not known
ERROR    app.services.notifications:notifications.py:64 Failed to publish notification: [Errno 8] nodename nor servname provided, or not known
WARNING  app.repositories.catalog:catalog.py:228 DB search failed, returning empty list (dev mode)
ERROR    app.services.dialogue_manager:dialogue_manager.py:165 DialogueManager: Error in bulk track generation: 'async_generator' object has no attribute 'add'
Traceback (most recent call last):
  File "/Users/artyomkonukhov/Projects/gifty-backend/app/services/dialogue_manager.py", line 157, in init_session
    await self.recipient_service.save_hypotheses(
  File "/Users/artyomkonukhov/Projects/gifty-backend/app/services/recipient_service.py", line 136, in save_hypotheses
    self.db.add(db_h)
AttributeError: 'async_generator' object has no attribute 'add'
ERROR    app.services.dialogue_manager:dialogue_manager.py:282 DialogueManager: Classification failed for topic 'Coffee': "Could not resolve authentication method. Expected either api_key or auth_token to be set. Or for one of the `X-Api-Key` or `Authorization` headers to be explicitly omitted"
ERROR    app.services.dialogue_manager:dialogue_manager.py:282 DialogueManager: Classification failed for topic 'Gadgets': "Could not resolve authentication method. Expected either api_key or auth_token to be set. Or for one of the `X-Api-Key` or `Authorization` headers to be explicitly omitted"
ERROR    routes.recommendations:recommendations.py:52 Failed to initialize discovery session
Traceback (most recent call last):
  File "/Users/artyomkonukhov/Projects/gifty-backend/app/services/dialogue_manager.py", line 157, in init_session
    await self.recipient_service.save_hypotheses(
  File "/Users/artyomkonukhov/Projects/gifty-backend/app/services/recipient_service.py", line 136, in save_hypotheses
    self.db.add(db_h)
AttributeError: 'async_generator' object has no attribute 'add'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/artyomkonukhov/Projects/gifty-backend/routes/recommendations.py", line 49, in init_discovery
    session = await manager.init_session(quiz, user_id=user_uuid)
  File "/Users/artyomkonukhov/Projects/gifty-backend/app/services/dialogue_manager.py", line 178, in init_session
    session.tracks = await asyncio.gather(*tasks, return_exceptions=False)
  File "/Users/artyomkonukhov/Projects/gifty-backend/app/services/dialogue_manager.py", line 300, in _create_track_for_topic
    raw_hypotheses = await self.anthropic_service.generate_hypotheses(
  File "/Users/artyomkonukhov/Projects/gifty-backend/app/services/anthropic_service.py", line 75, in generate_hypotheses
    response = await self.client.messages.create(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/anthropic/resources/messages/messages.py", line 2113, in create
    return await self._post(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/anthropic/_base_client.py", line 1898, in post
    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/anthropic/_base_client.py", line 1619, in request
    request = self._build_request(options, retries_taken=retries_taken)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/anthropic/_base_client.py", line 506, in _build_request
    headers = self._build_headers(options, retries_taken=retries_taken)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/anthropic/_base_client.py", line 447, in _build_headers
    self._validate_headers(headers_dict, custom_headers)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/anthropic/_client.py", line 436, in _validate_headers
    raise TypeError(
TypeError: "Could not resolve authentication method. Expected either api_key or auth_token to be set. Or for one of the `X-Api-Key` or `Authorization` headers to be explicitly omitted"
=============================== warnings summary ===============================
../../Library/Python/3.9/lib/python/site-packages/pydantic/_internal/_config.py:323
../../Library/Python/3.9/lib/python/site-packages/pydantic/_internal/_config.py:323
../../Library/Python/3.9/lib/python/site-packages/pydantic/_internal/_config.py:323
../../Library/Python/3.9/lib/python/site-packages/pydantic/_internal/_config.py:323
../../Library/Python/3.9/lib/python/site-packages/pydantic/_internal/_config.py:323
  /Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/pydantic/_internal/_config.py:323: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

tests/recommendations/test_discovery_e2e.py::test_full_discovery_flow_e2e
  /Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/_pytest/fixtures.py:1182: PytestRemovedIn9Warning: 'test_full_discovery_flow_e2e' requested an async fixture 'sqlite_db_session', with no plugin or hook that handled it. This is usually an error, as pytest does not natively support it. This will turn into an error in pytest 9.
  See: https://docs.pytest.org/en/stable/deprecations.html#sync-test-depending-on-async-fixture
    warnings.warn(

tests/recommendations/test_discovery_e2e.py::test_full_discovery_flow_e2e
  /Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/pytest_asyncio/plugin.py:678: PytestDeprecationWarning: asyncio test 'test_full_discovery_flow_e2e' requested async @pytest.fixture 'sqlite_db_session' in strict mode. You might want to use @pytest_asyncio.fixture or switch to auto mode. This will become an error in future versions of pytest-asyncio.
    warnings.warn(

tests/recommendations/test_discovery_e2e.py::test_full_discovery_flow_e2e
tests/recommendations/test_discovery_e2e.py::test_full_discovery_flow_e2e
  /Users/artyomkonukhov/Projects/gifty-backend/app/services/dialogue_manager.py:278: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    quiz_dict = session.full_recipient.quiz_data.dict() if session.full_recipient.quiz_data else {}

tests/recommendations/test_discovery_e2e.py::test_full_discovery_flow_e2e
  /Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/starlette/_exception_handler.py:59: DeprecationWarning: 'HTTP_422_UNPROCESSABLE_ENTITY' is deprecated. Use 'HTTP_422_UNPROCESSABLE_CONTENT' instead.
    response = await handler(conn, exc)

tests/recommendations/test_discovery_e2e.py::test_full_discovery_flow_e2e
  /Users/artyomkonukhov/Projects/gifty-backend/app/main.py:37: DeprecationWarning: Call to deprecated close. (Use aclose() instead) -- Deprecated since version 5.0.1.
    await app.state.redis.close()

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/recommendations/test_discovery_e2e.py::test_full_discovery_flow_e2e - assert 500 == 200
 +  where 500 = <Response [500 Internal Server Error]>.status_code
======================== 1 failed, 11 warnings in 0.59s ========================
