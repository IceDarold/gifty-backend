DEBUG_DB: Driver=postgresql+asyncpg, Host=localhost, DB=giftyai
DEBUG_DB: User=giftyai_user, Params=immutabledict({})
============================= test session starts ==============================
platform darwin -- Python 3.9.6, pytest-8.4.2, pluggy-1.6.0
Fugue tests will be initialized with options:
rootdir: /Users/artyomkonukhov/Projects/gifty-backend
configfile: pytest.ini
plugins: fugue-0.9.3, mock-3.15.1, asyncio-1.2.0, anyio-4.10.0, hydra-core-1.3.2, cov-7.0.0
asyncio: mode=strict, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 1 item

tests/recommendations/test_discovery_e2e.py F

=================================== FAILURES ===================================
_________________________ test_full_discovery_flow_e2e _________________________

e2e_client = <starlette.testclient.TestClient object at 0x114a49fa0>
sqlite_db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x114984580>
in_memory_session_storage = <conftest.in_memory_session_storage.<locals>.InMemorySessionStorage object at 0x114984160>

    @pytest.mark.asyncio
    async def test_full_discovery_flow_e2e(e2e_client, sqlite_db_session, in_memory_session_storage):
        """
        Test the full discovery flow path:
        1. /init -> Start session
        2. /interact -> Like a hypothesis
        3. /hypothesis/{id}/products -> Get recommendations
        4. /hypothesis/{id}/react -> Final reaction
        """
    
        # --- STEP 1: INIT ---
        quiz_data = {
            "interests": ["Coffee", "Gadgets"],
            "recipient_age": 30,
            "recipient_gender": "male",
            "budget": 5000,
            "deadline_days": 7,
            "effort_level": "medium",
            "language": "ru",
            "relationship": "friend"
        }
    
        mock_hypo_list = [
            {
                "id": str(uuid.uuid4()),
                "title": "AeroPress Kit",
                "description": "Brew anywhere",
                "reasoning": "He likes coffee",
                "primary_gap": "the_optimizer",
                "search_queries": ["aeropress"],
                "preview_products": []
            }
        ]
        mock_hypos_bulk = {
            "Coffee": {
                "hypotheses": mock_hypo_list
            },
            "Gadgets": {
                "hypotheses": [
                    {
                        "id": str(uuid.uuid4()),
                        "title": "Smart Light",
                        "description": "RGB goodness",
                        "reasoning": "He likes tech",
                        "primary_gap": "the_catalyst",
                        "search_queries": ["smart bulbs"],
                        "preview_products": []
                    }
                ]
            }
        }
    
        mock_notifier = AsyncMock()
    
        # We must patch get_session_storage inside the app module because routes use its singleton
        with patch("app.services.anthropic_service.AnthropicService.normalize_topics", AsyncMock(return_value=["Coffee", "Gadgets"])), \
             patch("app.services.anthropic_service.AnthropicService.generate_hypotheses_bulk", AsyncMock(return_value=mock_hypos_bulk)), \
             patch("app.services.anthropic_service.AnthropicService.generate_hypotheses", AsyncMock(return_value=mock_hypo_list)), \
             patch("app.services.dialogue_manager.get_notification_service", return_value=mock_notifier), \
             patch("routes.recommendations.get_session_storage", return_value=in_memory_session_storage):
    
            response = e2e_client.post("/api/v1/recommendations/init", json=quiz_data)
            assert response.status_code == 200, f"Init failed: {response.text}"
            session = response.json()
            session_id = session["session_id"]
            hypo_id = session["tracks"][0]["hypotheses"][0]["id"]
    
            # --- STEP 2: INTERACT (Like) ---
            interaction_data = {
                "session_id": session_id,
                "action": "like_hypothesis",
                "value": hypo_id
            }
    
            response = e2e_client.post("/api/v1/recommendations/interact", json=interaction_data)
            assert response.status_code == 200, f"Interact failed: {response.text}"
            updated_session = response.json()
            assert hypo_id in updated_session["liked_hypotheses"]
    
            # --- STEP 3: GET PRODUCTS ---
            from app.models import Product
            mock_product = Product(
                gift_id="prod-123",
                title="Test Coffee Maker",
                price=4500.0,
                product_url="https://example.com/p/123",
                is_active=True
            )
    
            with patch("app.repositories.catalog.PostgresCatalogRepository.search_similar_products", AsyncMock(return_value=[mock_product])):
                response = e2e_client.get(f"/api/v1/recommendations/hypothesis/{hypo_id}/products")
>               assert response.status_code == 200, f"Products failed: {response.text}"
E               AssertionError: Products failed: {"error":{"code":"http_error","message":"Internal server error"}}
E               assert 500 == 200
E                +  where 500 = <Response [500 Internal Server Error]>.status_code

tests/recommendations/test_discovery_e2e.py:124: AssertionError
------------------------------ Captured log call -------------------------------
WARNING  app.services.intelligence:intelligence.py:25 IntelligenceAPI token missing, using dummy embeddings.
WARNING  app.services.intelligence:intelligence.py:25 IntelligenceAPI token missing, using dummy embeddings.
ERROR    app.repositories.catalog:catalog.py:215 CatalogRepository.search_similar_products failed: (sqlite3.OperationalError) near ">": syntax error
[SQL: SELECT products.gift_id, products.title, products.description, products.price, products.currency, products.image_url, products.product_url, products.merchant, products.category, products.raw, products.is_active, products.content_text, products.content_hash, products.llm_gift_score, products.llm_gift_reasoning, products.llm_gift_vector, products.llm_scoring_model, products.llm_scoring_version, products.llm_scored_at, products.created_at, products.updated_at 
FROM products JOIN product_embeddings ON products.gift_id = product_embeddings.gift_id AND product_embeddings.model_name = ? 
WHERE products.is_active IS 1 AND products.price <= ? ORDER BY product_embeddings.embedding <=> ?
 LIMIT ? OFFSET ?]
[parameters: ('bge-m3', 5500, '[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0, ... (3799 characters truncated) ... ,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0]', 15, 0)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
ERROR    pika.adapters.utils.selector_ioloop_adapter:selector_ioloop_adapter.py:569 Address resolution failed: gaierror(8, 'nodename nor servname provided, or not known')
ERROR    pika.adapters.utils.connection_workflow:connection_workflow.py:799 getaddrinfo failed: gaierror(8, 'nodename nor servname provided, or not known').
ERROR    pika.adapters.utils.connection_workflow:connection_workflow.py:746 AMQP connection workflow failed: AMQPConnectionWorkflowFailed: 1 exceptions in all; last exception - gaierror(8, 'nodename nor servname provided, or not known'); first exception - None.
ERROR    pika.adapters.utils.connection_workflow:connection_workflow.py:723 AMQPConnectionWorkflow - reporting failure: AMQPConnectionWorkflowFailed: 1 exceptions in all; last exception - gaierror(8, 'nodename nor servname provided, or not known'); first exception - None
ERROR    pika.adapters.blocking_connection:blocking_connection.py:450 Connection workflow failed: AMQPConnectionWorkflowFailed: 1 exceptions in all; last exception - gaierror(8, 'nodename nor servname provided, or not known'); first exception - None
ERROR    pika.adapters.blocking_connection:blocking_connection.py:457 Error in _create_connection().
Traceback (most recent call last):
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py", line 177, in execute
    self._adapt_connection._handle_exception(error)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py", line 337, in _handle_exception
    raise error
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py", line 159, in execute
    self.await_(_cursor.execute(operation, parameters))
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/aiosqlite/cursor.py", line 40, in execute
    await self._execute(self._cursor.execute, sql, parameters)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/aiosqlite/cursor.py", line 32, in _execute
    return await self._conn._execute(fn, *args, **kwargs)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/aiosqlite/core.py", line 160, in _execute
    return await future
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/aiosqlite/core.py", line 63, in _connection_worker_thread
    result = function()
sqlite3.OperationalError: near ">": syntax error

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/artyomkonukhov/Projects/gifty-backend/app/repositories/catalog.py", line 212, in search_similar_products
    result = await self.session.execute(stmt)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/ext/asyncio/session.py", line 463, in execute
    result = await greenlet_spawn(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 201, in greenlet_spawn
    result = context.throw(*sys.exc_info())
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/orm/session.py", line 2365, in execute
    return self._execute_internal(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/orm/session.py", line 2251, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/orm/context.py", line 306, in orm_execute_statement
    result = conn.execute(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
    return meth(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/sql/elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/engine/base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/engine/base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py", line 177, in execute
    self._adapt_connection._handle_exception(error)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py", line 337, in _handle_exception
    raise error
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py", line 159, in execute
    self.await_(_cursor.execute(operation, parameters))
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/aiosqlite/cursor.py", line 40, in execute
    await self._execute(self._cursor.execute, sql, parameters)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/aiosqlite/cursor.py", line 32, in _execute
    return await self._conn._execute(fn, *args, **kwargs)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/aiosqlite/core.py", line 160, in _execute
    return await future
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/aiosqlite/core.py", line 63, in _connection_worker_thread
    result = function()
sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) near ">": syntax error
[SQL: SELECT products.gift_id, products.title, products.description, products.price, products.currency, products.image_url, products.product_url, products.merchant, products.category, products.raw, products.is_active, products.content_text, products.content_hash, products.llm_gift_score, products.llm_gift_reasoning, products.llm_gift_vector, products.llm_scoring_model, products.llm_scoring_version, products.llm_scored_at, products.created_at, products.updated_at 
FROM products JOIN product_embeddings ON products.gift_id = product_embeddings.gift_id AND product_embeddings.model_name = ? 
WHERE products.is_active IS 1 AND products.price <= ? ORDER BY product_embeddings.embedding <=> ?
 LIMIT ? OFFSET ?]
[parameters: ('bge-m3', 5500, '[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0, ... (3799 characters truncated) ... ,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0]', 15, 0)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/pika/adapters/blocking_connection.py", line 451, in _create_connection
    raise self._reap_last_connection_workflow_error(error)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/pika/adapters/utils/selector_ioloop_adapter.py", line 565, in _resolve
    result = socket.getaddrinfo(self._host, self._port, self._family,
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/socket.py", line 953, in getaddrinfo
    for res in _socket.getaddrinfo(host, port, family, type, proto, flags):
socket.gaierror: [Errno 8] nodename nor servname provided, or not known
ERROR    app.services.notifications:notifications.py:64 Failed to publish notification: [Errno 8] nodename nor servname provided, or not known
WARNING  app.repositories.catalog:catalog.py:228 DB search failed, returning empty list (dev mode)
ERROR    app.repositories.catalog:catalog.py:215 CatalogRepository.search_similar_products failed: (sqlite3.OperationalError) near ">": syntax error
[SQL: SELECT products.gift_id, products.title, products.description, products.price, products.currency, products.image_url, products.product_url, products.merchant, products.category, products.raw, products.is_active, products.content_text, products.content_hash, products.llm_gift_score, products.llm_gift_reasoning, products.llm_gift_vector, products.llm_scoring_model, products.llm_scoring_version, products.llm_scored_at, products.created_at, products.updated_at 
FROM products JOIN product_embeddings ON products.gift_id = product_embeddings.gift_id AND product_embeddings.model_name = ? 
WHERE products.is_active IS 1 AND products.price <= ? ORDER BY product_embeddings.embedding <=> ?
 LIMIT ? OFFSET ?]
[parameters: ('bge-m3', 5500, '[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0, ... (3799 characters truncated) ... ,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0]', 15, 0)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
ERROR    pika.adapters.utils.selector_ioloop_adapter:selector_ioloop_adapter.py:569 Address resolution failed: gaierror(8, 'nodename nor servname provided, or not known')
ERROR    pika.adapters.utils.connection_workflow:connection_workflow.py:799 getaddrinfo failed: gaierror(8, 'nodename nor servname provided, or not known').
ERROR    pika.adapters.utils.connection_workflow:connection_workflow.py:746 AMQP connection workflow failed: AMQPConnectionWorkflowFailed: 1 exceptions in all; last exception - gaierror(8, 'nodename nor servname provided, or not known'); first exception - None.
ERROR    pika.adapters.utils.connection_workflow:connection_workflow.py:723 AMQPConnectionWorkflow - reporting failure: AMQPConnectionWorkflowFailed: 1 exceptions in all; last exception - gaierror(8, 'nodename nor servname provided, or not known'); first exception - None
ERROR    pika.adapters.blocking_connection:blocking_connection.py:450 Connection workflow failed: AMQPConnectionWorkflowFailed: 1 exceptions in all; last exception - gaierror(8, 'nodename nor servname provided, or not known'); first exception - None
ERROR    pika.adapters.blocking_connection:blocking_connection.py:457 Error in _create_connection().
Traceback (most recent call last):
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py", line 177, in execute
    self._adapt_connection._handle_exception(error)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py", line 337, in _handle_exception
    raise error
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py", line 159, in execute
    self.await_(_cursor.execute(operation, parameters))
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/aiosqlite/cursor.py", line 40, in execute
    await self._execute(self._cursor.execute, sql, parameters)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/aiosqlite/cursor.py", line 32, in _execute
    return await self._conn._execute(fn, *args, **kwargs)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/aiosqlite/core.py", line 160, in _execute
    return await future
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/aiosqlite/core.py", line 63, in _connection_worker_thread
    result = function()
sqlite3.OperationalError: near ">": syntax error

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/artyomkonukhov/Projects/gifty-backend/app/repositories/catalog.py", line 212, in search_similar_products
    result = await self.session.execute(stmt)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/ext/asyncio/session.py", line 463, in execute
    result = await greenlet_spawn(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 201, in greenlet_spawn
    result = context.throw(*sys.exc_info())
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/orm/session.py", line 2365, in execute
    return self._execute_internal(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/orm/session.py", line 2251, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/orm/context.py", line 306, in orm_execute_statement
    result = conn.execute(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
    return meth(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/sql/elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/engine/base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/engine/base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py", line 177, in execute
    self._adapt_connection._handle_exception(error)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py", line 337, in _handle_exception
    raise error
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py", line 159, in execute
    self.await_(_cursor.execute(operation, parameters))
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/aiosqlite/cursor.py", line 40, in execute
    await self._execute(self._cursor.execute, sql, parameters)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/aiosqlite/cursor.py", line 32, in _execute
    return await self._conn._execute(fn, *args, **kwargs)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/aiosqlite/core.py", line 160, in _execute
    return await future
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/aiosqlite/core.py", line 63, in _connection_worker_thread
    result = function()
sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) near ">": syntax error
[SQL: SELECT products.gift_id, products.title, products.description, products.price, products.currency, products.image_url, products.product_url, products.merchant, products.category, products.raw, products.is_active, products.content_text, products.content_hash, products.llm_gift_score, products.llm_gift_reasoning, products.llm_gift_vector, products.llm_scoring_model, products.llm_scoring_version, products.llm_scored_at, products.created_at, products.updated_at 
FROM products JOIN product_embeddings ON products.gift_id = product_embeddings.gift_id AND product_embeddings.model_name = ? 
WHERE products.is_active IS 1 AND products.price <= ? ORDER BY product_embeddings.embedding <=> ?
 LIMIT ? OFFSET ?]
[parameters: ('bge-m3', 5500, '[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0, ... (3799 characters truncated) ... ,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0]', 15, 0)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/pika/adapters/blocking_connection.py", line 451, in _create_connection
    raise self._reap_last_connection_workflow_error(error)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/pika/adapters/utils/selector_ioloop_adapter.py", line 565, in _resolve
    result = socket.getaddrinfo(self._host, self._port, self._family,
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/socket.py", line 953, in getaddrinfo
    for res in _socket.getaddrinfo(host, port, family, type, proto, flags):
socket.gaierror: [Errno 8] nodename nor servname provided, or not known
ERROR    app.services.notifications:notifications.py:64 Failed to publish notification: [Errno 8] nodename nor servname provided, or not known
WARNING  app.repositories.catalog:catalog.py:228 DB search failed, returning empty list (dev mode)
WARNING  app.services.intelligence:intelligence.py:25 IntelligenceAPI token missing, using dummy embeddings.
ERROR    app.repositories.catalog:catalog.py:215 CatalogRepository.search_similar_products failed: (sqlite3.OperationalError) near ">": syntax error
[SQL: SELECT products.gift_id, products.title, products.description, products.price, products.currency, products.image_url, products.product_url, products.merchant, products.category, products.raw, products.is_active, products.content_text, products.content_hash, products.llm_gift_score, products.llm_gift_reasoning, products.llm_gift_vector, products.llm_scoring_model, products.llm_scoring_version, products.llm_scored_at, products.created_at, products.updated_at 
FROM products JOIN product_embeddings ON products.gift_id = product_embeddings.gift_id AND product_embeddings.model_name = ? 
WHERE products.is_active IS 1 AND products.price <= ? ORDER BY product_embeddings.embedding <=> ?
 LIMIT ? OFFSET ?]
[parameters: ('bge-m3', 5500, '[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0, ... (3799 characters truncated) ... ,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0]', 15, 0)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
ERROR    pika.adapters.utils.selector_ioloop_adapter:selector_ioloop_adapter.py:569 Address resolution failed: gaierror(8, 'nodename nor servname provided, or not known')
ERROR    pika.adapters.utils.connection_workflow:connection_workflow.py:799 getaddrinfo failed: gaierror(8, 'nodename nor servname provided, or not known').
ERROR    pika.adapters.utils.connection_workflow:connection_workflow.py:746 AMQP connection workflow failed: AMQPConnectionWorkflowFailed: 1 exceptions in all; last exception - gaierror(8, 'nodename nor servname provided, or not known'); first exception - None.
ERROR    pika.adapters.utils.connection_workflow:connection_workflow.py:723 AMQPConnectionWorkflow - reporting failure: AMQPConnectionWorkflowFailed: 1 exceptions in all; last exception - gaierror(8, 'nodename nor servname provided, or not known'); first exception - None
ERROR    pika.adapters.blocking_connection:blocking_connection.py:450 Connection workflow failed: AMQPConnectionWorkflowFailed: 1 exceptions in all; last exception - gaierror(8, 'nodename nor servname provided, or not known'); first exception - None
ERROR    pika.adapters.blocking_connection:blocking_connection.py:457 Error in _create_connection().
Traceback (most recent call last):
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py", line 177, in execute
    self._adapt_connection._handle_exception(error)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py", line 337, in _handle_exception
    raise error
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py", line 159, in execute
    self.await_(_cursor.execute(operation, parameters))
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/aiosqlite/cursor.py", line 40, in execute
    await self._execute(self._cursor.execute, sql, parameters)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/aiosqlite/cursor.py", line 32, in _execute
    return await self._conn._execute(fn, *args, **kwargs)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/aiosqlite/core.py", line 160, in _execute
    return await future
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/aiosqlite/core.py", line 63, in _connection_worker_thread
    result = function()
sqlite3.OperationalError: near ">": syntax error

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/artyomkonukhov/Projects/gifty-backend/app/repositories/catalog.py", line 212, in search_similar_products
    result = await self.session.execute(stmt)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/ext/asyncio/session.py", line 463, in execute
    result = await greenlet_spawn(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 201, in greenlet_spawn
    result = context.throw(*sys.exc_info())
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/orm/session.py", line 2365, in execute
    return self._execute_internal(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/orm/session.py", line 2251, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/orm/context.py", line 306, in orm_execute_statement
    result = conn.execute(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
    return meth(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/sql/elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/engine/base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/engine/base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py", line 177, in execute
    self._adapt_connection._handle_exception(error)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py", line 337, in _handle_exception
    raise error
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/dialects/sqlite/aiosqlite.py", line 159, in execute
    self.await_(_cursor.execute(operation, parameters))
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/aiosqlite/cursor.py", line 40, in execute
    await self._execute(self._cursor.execute, sql, parameters)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/aiosqlite/cursor.py", line 32, in _execute
    return await self._conn._execute(fn, *args, **kwargs)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/aiosqlite/core.py", line 160, in _execute
    return await future
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/aiosqlite/core.py", line 63, in _connection_worker_thread
    result = function()
sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) near ">": syntax error
[SQL: SELECT products.gift_id, products.title, products.description, products.price, products.currency, products.image_url, products.product_url, products.merchant, products.category, products.raw, products.is_active, products.content_text, products.content_hash, products.llm_gift_score, products.llm_gift_reasoning, products.llm_gift_vector, products.llm_scoring_model, products.llm_scoring_version, products.llm_scored_at, products.created_at, products.updated_at 
FROM products JOIN product_embeddings ON products.gift_id = product_embeddings.gift_id AND product_embeddings.model_name = ? 
WHERE products.is_active IS 1 AND products.price <= ? ORDER BY product_embeddings.embedding <=> ?
 LIMIT ? OFFSET ?]
[parameters: ('bge-m3', 5500, '[0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0, ... (3799 characters truncated) ... ,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0]', 15, 0)]
(Background on this error at: https://sqlalche.me/e/20/e3q8)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/pika/adapters/blocking_connection.py", line 451, in _create_connection
    raise self._reap_last_connection_workflow_error(error)
  File "/Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/pika/adapters/utils/selector_ioloop_adapter.py", line 565, in _resolve
    result = socket.getaddrinfo(self._host, self._port, self._family,
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/socket.py", line 953, in getaddrinfo
    for res in _socket.getaddrinfo(host, port, family, type, proto, flags):
socket.gaierror: [Errno 8] nodename nor servname provided, or not known
ERROR    app.services.notifications:notifications.py:64 Failed to publish notification: [Errno 8] nodename nor servname provided, or not known
WARNING  app.repositories.catalog:catalog.py:228 DB search failed, returning empty list (dev mode)
ERROR    routes.recommendations:recommendations.py:109 Failed to fetch products for hypothesis 74dc5379-4b10-4ef9-a629-47208219be87
Traceback (most recent call last):
  File "/Users/artyomkonukhov/Projects/gifty-backend/routes/recommendations.py", line 98, in get_hypothesis_products
    products = await manager.recommendation_service.find_recommendations(
AttributeError: 'RecommendationService' object has no attribute 'find_recommendations'
=============================== warnings summary ===============================
../../Library/Python/3.9/lib/python/site-packages/pydantic/_internal/_config.py:323
../../Library/Python/3.9/lib/python/site-packages/pydantic/_internal/_config.py:323
../../Library/Python/3.9/lib/python/site-packages/pydantic/_internal/_config.py:323
../../Library/Python/3.9/lib/python/site-packages/pydantic/_internal/_config.py:323
../../Library/Python/3.9/lib/python/site-packages/pydantic/_internal/_config.py:323
  /Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/pydantic/_internal/_config.py:323: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

tests/recommendations/test_discovery_e2e.py::test_full_discovery_flow_e2e
  /Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/starlette/_exception_handler.py:59: DeprecationWarning: 'HTTP_422_UNPROCESSABLE_ENTITY' is deprecated. Use 'HTTP_422_UNPROCESSABLE_CONTENT' instead.
    response = await handler(conn, exc)

tests/recommendations/test_discovery_e2e.py::test_full_discovery_flow_e2e
  /Users/artyomkonukhov/Projects/gifty-backend/app/main.py:37: DeprecationWarning: Call to deprecated close. (Use aclose() instead) -- Deprecated since version 5.0.1.
    await app.state.redis.close()

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/recommendations/test_discovery_e2e.py::test_full_discovery_flow_e2e
======================== 1 failed, 7 warnings in 0.51s =========================
