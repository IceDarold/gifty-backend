DEBUG_DB: Driver=postgresql+asyncpg, Host=localhost, DB=giftyai
DEBUG_DB: User=giftyai_user, Params=immutabledict({})
============================= test session starts ==============================
platform darwin -- Python 3.9.6, pytest-8.4.2, pluggy-1.6.0 -- /Library/Developer/CommandLineTools/usr/bin/python3
cachedir: .pytest_cache
Fugue tests will be initialized with options:
rootdir: /Users/artyomkonukhov/Projects/gifty-backend
configfile: pytest.ini
plugins: fugue-0.9.3, mock-3.15.1, asyncio-1.2.0, anyio-4.10.0, hydra-core-1.3.2, cov-7.0.0
asyncio: mode=strict, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 1 item

tests/recommendations/test_discovery_e2e.py::test_full_discovery_flow_e2e FAILED

=================================== FAILURES ===================================
_________________________ test_full_discovery_flow_e2e _________________________

e2e_client = <starlette.testclient.TestClient object at 0x111c32340>
sqlite_db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x111b5c850>
in_memory_session_storage = <conftest.in_memory_session_storage.<locals>.InMemorySessionStorage object at 0x111b5c430>

    @pytest.mark.asyncio
    async def test_full_discovery_flow_e2e(e2e_client, sqlite_db_session, in_memory_session_storage):
        """
        Test the full discovery flow path:
        1. /init -> Start session
        2. /interact -> Like a hypothesis
        3. /hypothesis/{id}/products -> Get recommendations
        4. /hypothesis/{id}/react -> Final reaction
        """
    
        # --- STEP 1: INIT ---
        quiz_data = {
            "interests": ["Coffee", "Gadgets"],
            "recipient_age": 30,
            "recipient_gender": "male",
            "budget": 5000,
            "deadline_days": 7,
            "effort_level": "medium",
            "language": "ru",
            "relationship": "friend"
        }
    
        mock_hypo_id = str(uuid.uuid4())
        mock_hypo_list = [
            {
                "id": mock_hypo_id,
                "title": "AeroPress Kit",
                "description": "Brew anywhere",
                "reasoning": "He likes coffee",
                "primary_gap": "the_optimizer",
                "search_queries": ["aeropress"],
                "preview_products": []
            }
        ]
        mock_hypos_bulk = {
            "Coffee": {
                "hypotheses": mock_hypo_list
            },
            "Gadgets": {
                "hypotheses": [
                    {
                        "id": str(uuid.uuid4()),
                        "title": "Smart Light",
                        "description": "RGB goodness",
                        "reasoning": "He likes tech",
                        "primary_gap": "the_catalyst",
                        "search_queries": ["smart bulbs"],
                        "preview_products": []
                    }
                ]
            }
        }
    
        mock_notifier = AsyncMock()
    
        with patch("app.services.anthropic_service.AnthropicService.normalize_topics", AsyncMock(return_value=["Coffee", "Gadgets"])), \
             patch("app.services.anthropic_service.AnthropicService.generate_hypotheses_bulk", AsyncMock(return_value=mock_hypos_bulk)), \
             patch("app.services.anthropic_service.AnthropicService.generate_hypotheses", AsyncMock(return_value=mock_hypo_list)), \
             patch("app.services.dialogue_manager.get_notification_service", return_value=mock_notifier), \
             patch("routes.recommendations.get_session_storage", return_value=in_memory_session_storage):
    
            response = e2e_client.post("/api/v1/recommendations/init", json=quiz_data)
            assert response.status_code == 200, f"Init failed: {response.text}"
            session = response.json()
            session_id = session["session_id"]
    
            # Find hypothesis ID from tracks
            hypo_id = None
            for track in session["tracks"]:
                for h in track["hypotheses"]:
                    if h["title"] == "AeroPress Kit":
                        hypo_id = h["id"]
                        break
            assert hypo_id is not None
    
            # --- STEP 2: INTERACT (Like) ---
            interaction_data = {
                "session_id": session_id,
                "action": "like_hypothesis",
                "value": hypo_id
            }
    
            response = e2e_client.post("/api/v1/recommendations/interact", json=interaction_data)
            assert response.status_code == 200, f"Interact failed: {response.text}"
            updated_session = response.json()
            assert hypo_id in updated_session["liked_hypotheses"]
    
            # --- STEP 3: GET PRODUCTS ---
            response = e2e_client.get(f"/api/v1/recommendations/hypothesis/{hypo_id}/products")
            assert response.status_code == 200, f"Products failed: {response.text}"
            products = response.json()
            assert len(products) > 0
    
            # --- STEP 4: FINAL REACTION ---
            response = e2e_client.post(f"/api/v1/recommendations/hypothesis/{hypo_id}/react?reaction=shortlist")
            assert response.status_code == 200, f"React failed: {response.text}"
            assert response.json()["reaction"] == "shortlist"
    
        # --- DB VERIFICATION ---
        from app.models import Recipient, Interaction, Hypothesis as DbHypothesis
        from sqlalchemy import select
    
        res = await sqlite_db_session.execute(select(Recipient))
        recipients = res.scalars().all()
>       assert len(recipients) > 0
E       assert 0 > 0
E        +  where 0 = len([])

tests/recommendations/test_discovery_e2e.py:159: AssertionError
=============================== warnings summary ===============================
../../Library/Python/3.9/lib/python/site-packages/pydantic/_internal/_config.py:323
../../Library/Python/3.9/lib/python/site-packages/pydantic/_internal/_config.py:323
../../Library/Python/3.9/lib/python/site-packages/pydantic/_internal/_config.py:323
../../Library/Python/3.9/lib/python/site-packages/pydantic/_internal/_config.py:323
../../Library/Python/3.9/lib/python/site-packages/pydantic/_internal/_config.py:323
  /Users/artyomkonukhov/Library/Python/3.9/lib/python/site-packages/pydantic/_internal/_config.py:323: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

tests/recommendations/test_discovery_e2e.py::test_full_discovery_flow_e2e
  /Users/artyomkonukhov/Projects/gifty-backend/app/main.py:37: DeprecationWarning: Call to deprecated close. (Use aclose() instead) -- Deprecated since version 5.0.1.
    await app.state.redis.close()

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/recommendations/test_discovery_e2e.py::test_full_discovery_flow_e2e - assert 0 > 0
 +  where 0 = len([])
======================== 1 failed, 6 warnings in 0.53s =========================
